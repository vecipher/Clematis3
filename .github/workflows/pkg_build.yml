name: Reproducible Build (sdist & wheel)

on:
  pull_request:
    paths:
      - "pyproject.toml"
      - "MANIFEST.in"
      - "clematis/**"
      - "docs/m8/**"
      - ".github/workflows/**"
  push:
    branches: [ main ]

jobs:
  reproducible:
    runs-on: ubuntu-latest
    env:
      # Repro knobs
      SOURCE_DATE_EPOCH: "1704067200"   # 2024-01-01T00:00:00Z (example)
      PYTHONHASHSEED: "0"
      TZ: "UTC"
      LC_ALL: "C.UTF-8"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      CLEMATIS_NETWORK_BAN: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip build

      - name: Build #1
        run: |
          set -euo pipefail
          rm -rf build dist *.egg-info
          python -m build
          ls -l dist

      - name: Twine check
        run: |
          python -m pip install --upgrade twine
          python -m twine check dist/*

      - name: Canonicalize & hash #1
        run: |
          set -euo pipefail
          SDIST=$(ls dist/*.tar.gz)
          WHEEL=$(ls dist/*.whl)
          TMP=$(mktemp -d)
          # Ungzip to tar, normalize tar metadata and order, then gzip with fixed header
          gzip -dc "$SDIST" | tar -C "$TMP" -x
          tar --mtime="@$SOURCE_DATE_EPOCH" \
              --sort=name --owner=0 --group=0 --numeric-owner \
              -cf /tmp/sdist1.tar -C "$TMP" .
          gzip -n -c /tmp/sdist1.tar > /tmp/sdist1.tgz
          WH=$(sha256sum "$WHEEL" | awk '{print $1}')
          SH1=$(sha256sum /tmp/sdist1.tgz | awk '{print $1}')
          printf "%s  %s\n" "$WH" "WHEEL" > /tmp/hashes1.txt
          printf "%s  %s\n" "$SH1" "SDIST" >> /tmp/hashes1.txt

      - name: Build #2 (clean)
        run: |
          set -euo pipefail
          rm -rf build dist *.egg-info
          python -m build
          ls -l dist

      - name: Canonicalize & hash #2 and compare
        run: |
          set -euo pipefail
          SDIST=$(ls dist/*.tar.gz)
          WHEEL=$(ls dist/*.whl)
          TMP=$(mktemp -d)
          gzip -dc "$SDIST" | tar -C "$TMP" -x
          tar --mtime="@$SOURCE_DATE_EPOCH" \
              --sort=name --owner=0 --group=0 --numeric-owner \
              -cf /tmp/sdist2.tar -C "$TMP" .
          gzip -n -c /tmp/sdist2.tar > /tmp/sdist2.tgz
          WH=$(sha256sum "$WHEEL" | awk '{print $1}')
          SH2=$(sha256sum /tmp/sdist2.tgz | awk '{print $1}')
          printf "%s  %s\n" "$WH" "WHEEL" > /tmp/hashes2.txt
          printf "%s  %s\n" "$SH2" "SDIST" >> /tmp/hashes2.txt
          echo "=== DIFF (should be empty) ==="
          diff -u /tmp/hashes1.txt /tmp/hashes2.txt

  pkg-smoke-matrix:
    name: Pkg smoke (${{ matrix.os }} / py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11", "3.12"]
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONUTF8: "1"
      PYTHONHASHSEED: "0"
      CLEMATIS_NETWORK_BAN: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Ensure long paths on Windows
        if: runner.os == 'Windows'
        run: git config --global core.longpaths true
        shell: pwsh

      - name: Install build backend
        run: python -m pip install --upgrade pip build

      - name: Build wheel (axis-local)
        run: python -m build --wheel

      - name: Smoke (posix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          WHL="$(ls dist/*.whl | head -n1)"
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install "$WHL[cli-demo]"

          # 1) version
          python -m clematis --version

          # 2) validate
          python -m clematis validate --json

          # 3) demo minimal
          python -m clematis demo -- --steps 1
          
          # 4) rotate-logs (dry-run)
          python -m clematis rotate-logs -- --dry-run

          # 5) inspect-snapshot (json)
          python -m clematis inspect-snapshot -- --format json

      - name: Smoke (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $whl = (Get-ChildItem dist\*.whl | Select-Object -First 1).FullName
          python -m venv .venv
          .\.venv\Scripts\python -m pip install --upgrade pip
          .\.venv\Scripts\python -m pip install "$whl[cli-demo]"

          # 1) version
          .\.venv\Scripts\python -m clematis --version

          # 2) validate
          .\.venv\Scripts\python -m clematis validate --json

          # 3) demo minimal
          .\.venv\Scripts\python -m clematis demo -- --steps 1

          # 4) rotate-logs (dry-run)
          .\.venv\Scripts\python -m clematis rotate-logs -- --dry-run

          # 5) inspect-snapshot (json)
          .\.venv\Scripts\python -m clematis inspect-snapshot -- --format json

      - name: Upload wheel (artifact per axis)
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.python-version }}
          path: dist/*.whl