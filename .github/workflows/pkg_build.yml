name: Reproducible Build (sdist & wheel)

on:
  pull_request:
    paths:
      - "pyproject.toml"
      - "MANIFEST.in"
      - "clematis/**"
      - "docs/m8/**"
      - ".github/workflows/**"
      - "tests/**"
  push:
    branches: [ "**" ]
    tags:
      - 'v*'
  release:
    types: [ published ]

jobs:
  reproducible:
    if: ${{ (github.event_name == 'pull_request') || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')) }}
    runs-on: ubuntu-latest
    env:
      # Repro knobs
      SOURCE_DATE_EPOCH: "1704067200"   # 2024-01-01T00:00:00Z (example)
      PYTHONHASHSEED: "0"
      TZ: "UTC"
      LC_ALL: "C.UTF-8"
      PYTHONIOENCODING: "UTF-8"
      PYTHONUTF8: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      CLEMATIS_NETWORK_BAN: "1"
    steps:
      - uses: actions/checkout@v4
      - name: Ensure repro script is executable
        run: chmod +x scripts/repro_check_local.sh

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install build tooling (pinned)
        run: |
          python -m pip install -U pip
          python -m pip install --no-deps \
            build==1.2.1 \
            wheel==0.45.1 \
            setuptools==80.9.0 \
            pyproject-hooks==1.1.0 \
            packaging==24.1

      - name: Generate manpages (deterministic)
        run: |
          python scripts/gen_manpages.py --outdir man --module clematis --section 1

      - name: Build #1
        run: |
          set -euo pipefail
          rm -rf build dist *.egg-info
          python -m build
          ls -l dist

      - name: Canonicalize wheel (zip) #1
        run: |
          python - <<'PY'
          import os, sys, zipfile, pathlib
          from datetime import datetime, timezone
          dist = pathlib.Path("dist")
          wheels = sorted(dist.glob("*.whl"))
          assert wheels, "no wheel found in dist/"
          src = wheels[0]
          dst = src.with_suffix(".whl.tmp")
          sde = int(os.environ.get("SOURCE_DATE_EPOCH", "0"))
          # ZIP can't represent pre-1980; but our SDE is set from git/tag anyway.
          if sde < 315532800:
            sde = 315532800
          dt = datetime.fromtimestamp(sde, tz=timezone.utc)
          fixed = (dt.year, dt.month, dt.day, dt.hour, dt.minute, dt.second)
          with zipfile.ZipFile(src, "r") as zin, zipfile.ZipFile(
              dst, "w", compression=zipfile.ZIP_DEFLATED, compresslevel=9
          ) as zout:
              for name in sorted(zin.namelist()):
                  if name.endswith("/"):
                      zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                      zi.create_system = 3  # pretend Unix
                      zi.external_attr = (0o755 & 0xFFFF) << 16
                      zout.writestr(zi, b"")
                      continue
                  data = zin.read(name)
                  info = zin.getinfo(name)
                  zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                  zi.compress_type = zipfile.ZIP_DEFLATED
                  zi.create_system = 3  # force Unix for stable external_attr semantics
                  # Preserve exec bit if present or if shebang detected; else 0644
                  mode = 0o644
                  orig_mode = (info.external_attr >> 16) & 0o7777
                  if (orig_mode & 0o111) or data.startswith(b"#!"):
                      mode = 0o755
                  zi.external_attr = (mode & 0xFFFF) << 16
                  zout.writestr(zi, data)
          os.replace(dst, src)
          print("Canonicalized wheel:", src)
          PY

      - name: Twine check
        run: |
          python -m pip install -U pip
          # Install Twine with its dependencies normally; reproducibility of artifacts
          # does not depend on Twine's transitive versions.
          python -m pip install twine==5.1.1
          python -m twine check dist/*

      - name: Upload manpages artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manpages
          path: man/*.1

      - name: Verify manpages in sdist & wheel (Build #1)
        run: |
          python -c "import tarfile,zipfile,glob; s=sorted(glob.glob('dist/*.tar.gz'))[-1]; w=sorted(glob.glob('dist/*.whl'))[-1]; import tarfile as _t, zipfile as _z; names=[m.name for m in _t.open(s,'r:gz').getmembers()]; assert any(n.endswith('/man/clematis.1') for n in names), 'sdist missing man/clematis.1'; names=_z.ZipFile(w).namelist(); assert any(n.endswith('/share/man/man1/clematis.1') for n in names), 'wheel missing share/man/man1/clematis.1'; print('OK: manpages present in both sdist & wheel.')"

      - name: Render check (best effort)
        continue-on-error: true
        run: |
          if command -v man >/dev/null 2>&1; then
            man -l man/clematis.1 | col -b | head -n 20
          else
            echo "man(1) not available on runner"
          fi

      - name: Canonicalize & hash #1
        run: |
          set -euo pipefail
          SDIST=$(ls dist/*.tar.gz)
          WHEEL=$(ls dist/*.whl)
          TMP=$(mktemp -d)
          # Ungzip to tar, normalize tar metadata and order, then gzip with fixed header
          gzip -dc "$SDIST" | tar -C "$TMP" -x
          tar --mtime="@$SOURCE_DATE_EPOCH" \
              --sort=name --owner=0 --group=0 --numeric-owner \
              -cf /tmp/sdist1.tar -C "$TMP" .
          gzip -n -c /tmp/sdist1.tar > /tmp/sdist1.tgz
          WH=$(sha256sum "$WHEEL" | awk '{print $1}')
          SH1=$(sha256sum /tmp/sdist1.tgz | awk '{print $1}')
          printf "%s  %s\n" "$WH" "WHEEL" > /tmp/hashes1.txt
          printf "%s  %s\n" "$SH1" "SDIST" >> /tmp/hashes1.txt

      - name: Build #2 (clean)
        run: |
          set -euo pipefail
          rm -rf build dist *.egg-info
          python -m build
          ls -l dist

      - name: Canonicalize wheel (zip) #2
        run: |
          python - <<'PY'
          import os, sys, zipfile, pathlib
          from datetime import datetime, timezone
          dist = pathlib.Path("dist")
          wheels = sorted(dist.glob("*.whl"))
          assert wheels, "no wheel found in dist/"
          src = wheels[0]
          dst = src.with_suffix(".whl.tmp")
          sde = int(os.environ.get("SOURCE_DATE_EPOCH", "0"))
          if sde < 315532800:
            sde = 315532800
          dt = datetime.fromtimestamp(sde, tz=timezone.utc)
          fixed = (dt.year, dt.month, dt.day, dt.hour, dt.minute, dt.second)
          with zipfile.ZipFile(src, "r") as zin, zipfile.ZipFile(
              dst, "w", compression=zipfile.ZIP_DEFLATED, compresslevel=9
          ) as zout:
              for name in sorted(zin.namelist()):
                  if name.endswith("/"):
                      zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                      zi.create_system = 3
                      zi.external_attr = (0o755 & 0xFFFF) << 16
                      zout.writestr(zi, b"")
                      continue
                  data = zin.read(name)
                  info = zin.getinfo(name)
                  zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                  zi.compress_type = zipfile.ZIP_DEFLATED
                  zi.create_system = 3
                  mode = 0o644
                  orig_mode = (info.external_attr >> 16) & 0o7777
                  if (orig_mode & 0o111) or data.startswith(b"#!"):
                      mode = 0o755
                  zi.external_attr = (mode & 0xFFFF) << 16
                  zout.writestr(zi, data)
          os.replace(dst, src)
          print("Canonicalized wheel:", src)
          PY

      - name: Canonicalize & hash #2 and compare
        run: |
          set -euo pipefail
          SDIST=$(ls dist/*.tar.gz)
          WHEEL=$(ls dist/*.whl)
          TMP=$(mktemp -d)
          gzip -dc "$SDIST" | tar -C "$TMP" -x
          tar --mtime="@$SOURCE_DATE_EPOCH" \
              --sort=name --owner=0 --group=0 --numeric-owner \
              -cf /tmp/sdist2.tar -C "$TMP" .
          gzip -n -c /tmp/sdist2.tar > /tmp/sdist2.tgz
          WH=$(sha256sum "$WHEEL" | awk '{print $1}')
          SH2=$(sha256sum /tmp/sdist2.tgz | awk '{print $1}')
          printf "%s  %s\n" "$WH" "WHEEL" > /tmp/hashes2.txt
          printf "%s  %s\n" "$SH2" "SDIST" >> /tmp/hashes2.txt
          echo "=== DIFF (should be empty) ==="
          diff -u /tmp/hashes1.txt /tmp/hashes2.txt

  pkg-smoke-matrix:
    if: ${{ (github.event_name == 'pull_request') || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')) }}
    name: Pkg smoke (${{ matrix.os }} / py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11", "3.12", "3.13"]
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONUTF8: "1"
      PYTHONHASHSEED: "0"
      CLEMATIS_NETWORK_BAN: "1"
      TZ: "UTC"
      PYTHONIOENCODING: "UTF-8"
    steps:
      - name: Configure Git EOL (Windows, before checkout)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify no CRLF in text files
        shell: bash
        run: |
          set -euo pipefail
          if git grep -I -n $'\r' -- '*.py' '*.md' '*.txt' '*.toml' '*.yml' '*.yaml' '*.json' '*.ini' '*.cfg' '*.sh' >/dev/null; then
            echo "CRLF detected in repository; normalize to LF for reproducible builds."
            git grep -I -n $'\r' -- '*.py' '*.md' '*.txt' '*.toml' '*.yml' '*.yaml' '*.json' '*.ini' '*.cfg' '*.sh' || true
            exit 1
          fi

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Deterministic env
        shell: bash
        run: |
          set -euo pipefail
          TS="$(git log -1 --pretty=%ct 2>/dev/null || echo 0)"
          echo "SOURCE_DATE_EPOCH=${TS}" >> "$GITHUB_ENV"
          echo "TZ=UTC" >> "$GITHUB_ENV"
          echo "PYTHONIOENCODING=UTF-8" >> "$GITHUB_ENV"
          echo "PYTHONUTF8=1" >> "$GITHUB_ENV"
          echo "PYTHONHASHSEED=0" >> "$GITHUB_ENV"

      - name: Ensure long paths on Windows
        if: runner.os == 'Windows'
        run: git config --global core.longpaths true
        shell: pwsh

      - name: Install build backend (pinned)
        shell: bash
        run: |
          python -m pip install -U pip
          python -m pip install --no-deps \
            build==1.2.1 \
            wheel==0.45.1 \
            setuptools==80.9.0 \
            pyproject-hooks==1.1.0 \
            packaging==24.1

      - name: Build sdist + wheel (axis-local)
        run: python -m build --sdist --wheel

      - name: Canonicalize wheel (axis-local)
        shell: bash
        run: |
          python - <<'PY'
          import os, sys, zipfile, pathlib
          from datetime import datetime, timezone
          dist = pathlib.Path("dist")
          wheels = sorted(dist.glob("*.whl"))
          assert wheels, "no wheel found in dist/"
          src = wheels[0]
          dst = src.with_suffix(".whl.tmp")
          sde = int(os.environ.get("SOURCE_DATE_EPOCH", "0"))
          if sde < 315532800:
            sde = 315532800
          dt = datetime.fromtimestamp(sde, tz=timezone.utc)
          fixed = (dt.year, dt.month, dt.day, dt.hour, dt.minute, dt.second)
          with zipfile.ZipFile(src, "r") as zin, zipfile.ZipFile(
              dst, "w", compression=zipfile.ZIP_DEFLATED, compresslevel=9
          ) as zout:
              for name in sorted(zin.namelist()):
                  if name.endswith("/"):
                      zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                      zi.create_system = 3
                      zi.external_attr = (0o755 & 0xFFFF) << 16
                      zout.writestr(zi, b"")
                      continue
                  data = zin.read(name)
                  info = zin.getinfo(name)
                  zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                  zi.compress_type = zipfile.ZIP_DEFLATED
                  zi.create_system = 3
                  mode = 0o644
                  orig_mode = (info.external_attr >> 16) & 0o7777
                  if (orig_mode & 0o111) or data.startswith(b"#!"):
                      mode = 0o755
                  zi.external_attr = (mode & 0xFFFF) << 16
                  zout.writestr(zi, data)
          os.replace(dst, src)
          print("Canonicalized wheel:", src)
          PY

      - name: Smoke (posix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          WHL="$(ls dist/*.whl | head -n1)"
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install "$WHL[cli-demo]"

          # 1) version
          python -m clematis --version

          # 2) validate
          python -m clematis validate --json

          # 3) demo minimal
          python -m clematis demo -- --steps 1

          # 4) rotate-logs (dry-run)
          python -m clematis rotate-logs -- --dry-run

          # 5) inspect-snapshot (json)
          python -m clematis inspect-snapshot -- --format json

      - name: Verify installed manpage (Linux only)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          .venv/bin/python -c "import sysconfig, pathlib; d=sysconfig.get_paths()['data']; p=pathlib.Path(d)/'share'/'man'/'man1'/'clematis.1'; print('Expect manpage at:', p); assert p.exists(), f'installed manpage missing: {p}'; print('OK: installed man page present')"

      - name: CLI contract probes (Linux only)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate

          echo "validate --json (should succeed)"
          python -m clematis validate --json > /dev/null

          echo "inspect-snapshot missing dir (expect exit 2)"
          set +e
          python -m clematis inspect-snapshot -- --dir does_not_exist_dir_12345
          rc=$?
          set -e
          if [ "$rc" -ne 2 ]; then
            echo "Expected exit 2, got $rc" >&2
            exit 1
          fi

          echo "demo mutual exclusion (expect exit 1)"
          set +e
          python -m clematis demo -- --steps 1 --json --table
          rc=$?
          set -e
          if [ "$rc" -ne 1 ]; then
            echo "Expected exit 1, got $rc" >&2
            exit 1
          fi

          echo "rotate-logs structured summaries (both should succeed)"
          python -m clematis rotate-logs -- --dry-run --json > /dev/null
          python -m clematis rotate-logs -- --dry-run --table > /dev/null

      - name: Smoke (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $whl = (Get-ChildItem dist\*.whl | Select-Object -First 1).FullName
          python -m venv .venv
          .\.venv\Scripts\python -m pip install --upgrade pip
          .\.venv\Scripts\python -m pip install "$whl[cli-demo]"

          # 1) version
          .\.venv\Scripts\python -m clematis --version

          # 2) validate
          .\.venv\Scripts\python -m clematis validate --json

          # 3) demo minimal
          .\.venv\Scripts\python -m clematis demo -- --steps 1

          # 4) rotate-logs (dry-run)
          .\.venv\Scripts\python -m clematis rotate-logs -- --dry-run

          # 5) inspect-snapshot (json)
          .\.venv\Scripts\python -m clematis inspect-snapshot -- --format json

      - name: Upload artifacts (wheel + sdist per axis)
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            dist/*.whl
            dist/*.tar.gz

  repro-compare:
    name: Reproducibility compare (cross-OS wheels)
    if: ${{ (github.event_name == 'pull_request') || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')) }}
    runs-on: ubuntu-latest
    needs: [pkg-smoke-matrix]
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: _artifacts
      - name: Show downloaded
        run: |
          find _artifacts -type f -maxdepth 3 -print | sort
      - name: Compare SHA256 across OS for identical wheel filenames
        run: |
          set -euo pipefail
          python - <<'PY'
          import hashlib, pathlib, collections
          root = pathlib.Path("_artifacts")
          files = [p for p in root.rglob("*.whl") if p.is_file()]
          groups = collections.defaultdict(list)
          for p in files:
              groups[p.name].append(p)
          bad = []
          for name, paths in sorted(groups.items()):
              digests = []
              for p in sorted(paths):
                  h = hashlib.sha256(p.read_bytes()).hexdigest()
                  digests.append((h, p))
              if len(set(h for h, _ in digests)) != 1:
                  print(f"[DIFF] {name}")
                  for h, p in digests:
                      print(f"  {h}  {p}")
                  bad.append(name)
          if bad:
              raise SystemExit(1)
          print("Repro check passed: all wheels with the same filename are byte-identical.")
          PY
      - name: Compare SHA256 across OS for identical sdist filenames
        run: |
          set -euo pipefail
          python - <<'PY'
          import hashlib, pathlib, collections
          root = pathlib.Path("_artifacts")
          files = [p for p in root.rglob("*.tar.gz") if p.is_file()]
          groups = collections.defaultdict(list)
          for p in files:
              groups[p.name].append(p)
          bad = []
          for name, paths in sorted(groups.items()):
              digests = []
              for p in sorted(paths):
                  h = hashlib.sha256(p.read_bytes()).hexdigest()
                  digests.append((h, p))
              if len(set(h for h, _ in digests)) != 1:
                  print(f"[DIFF] {name}")
                  for h, p in digests:
                      print(f"  {h}  {p}")
                  bad.append(name)
          if bad:
              raise SystemExit(1)
          print("Repro check passed: all sdists with the same filename are byte-identical.")
          PY

  tag-sbom-attest:
    name: "Tag: build → SBOM → attest"
    if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'release' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Build sdist + wheel (deterministic)
        env:
          SOURCE_DATE_EPOCH: "1704067200"
          TZ: "UTC"
          PYTHONHASHSEED: "0"
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "UTF-8"
        run: |
          python -m pip install -U pip
          python -m pip install --no-deps \
            build==1.2.1 \
            wheel==0.45.1 \
            setuptools==80.9.0 \
            pyproject-hooks==1.1.0 \
            packaging==24.1
          # Install Twine with dependencies (no --no-deps) for README/metadata checks
          python -m pip install twine==5.1.1
          python -m build
          # Canonicalize wheel for cross-OS reproducibility
          python - <<'PY'
          import os, sys, zipfile, pathlib
          from datetime import datetime, timezone
          dist = pathlib.Path("dist")
          wheels = sorted(dist.glob("*.whl"))
          assert wheels, "no wheel found in dist/"
          src = wheels[0]
          dst = src.with_suffix(".whl.tmp")
          sde = int(os.environ.get("SOURCE_DATE_EPOCH", "0"))
          if sde < 315532800:
            sde = 315532800
          dt = datetime.fromtimestamp(sde, tz=timezone.utc)
          fixed = (dt.year, dt.month, dt.day, dt.hour, dt.minute, dt.second)
          with zipfile.ZipFile(src, "r") as zin, zipfile.ZipFile(
              dst, "w", compression=zipfile.ZIP_DEFLATED, compresslevel=9
          ) as zout:
              for name in sorted(zin.namelist()):
                  if name.endswith("/"):
                      zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                      zi.create_system = 3
                      zi.external_attr = (0o755 & 0xFFFF) << 16
                      zout.writestr(zi, b"")
                      continue
                  data = zin.read(name)
                  info = zin.getinfo(name)
                  zi = zipfile.ZipInfo(filename=name, date_time=fixed)
                  zi.compress_type = zipfile.ZIP_DEFLATED
                  zi.create_system = 3
                  mode = 0o644
                  orig_mode = (info.external_attr >> 16) & 0o7777
                  if (orig_mode & 0o111) or data.startswith(b"#!"):
                      mode = 0o755
                  zi.external_attr = (mode & 0xFFFF) << 16
                  zout.writestr(zi, data)
          os.replace(dst, src)
          print("Canonicalized wheel:", src)
          PY
          python -m twine check dist/*

      - name: Upload artifacts to Release (sdist + wheel)
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/*.whl
          fail_on_unmatched_files: true

      - name: Generate CycloneDX SBOM (from clean venv)
        run: |
          python -m venv .sbom
          . .sbom/bin/activate
          python -m pip install --upgrade pip
          python -m pip install 'cyclonedx-bom>=4,<5'
          python -m pip install "dist/"*.whl[cli-demo] || python -m pip install dist/*.whl
          python -m cyclonedx_py environment \
            --output-format JSON \
            --schema-version 1.5 \
            --outfile dist/sbom.cdx.json
          deactivate

      - name: Verify SBOM is valid JSON
        run: |
          python - <<'PY'
          import json, sys
          json.load(open('dist/sbom.cdx.json'))
          print("SBOM JSON OK")
          PY

      - name: Upload SBOM as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: dist/sbom.cdx.json
          if-no-files-found: error

      - name: Attest provenance (wheel + sdist)
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            dist/*.whl
            dist/*.tar.gz

      - name: Attach SBOM to Release
        if: ${{ github.event_name == 'release' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" dist/sbom.cdx.json --clobber
