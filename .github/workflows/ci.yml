name: ci
on:
  push: { branches: [main] }
  pull_request: { branches: [main] }

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: UTC
  PYTHONUTF8: "1"
  PYTHONHASHSEED: "0"
  LC_ALL: C.UTF-8
  SOURCE_DATE_EPOCH: "315532800"

jobs:
  lint_types:
    name: Lint & Types
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          check-latest: true
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml

      - name: Deterministic env
        run: |
          echo "PYTHONUTF8=1" >> "$GITHUB_ENV"
          echo "PYTHONIOENCODING=UTF-8" >> "$GITHUB_ENV"
          echo "PYTHONHASHSEED=0" >> "$GITHUB_ENV"
          echo "TZ=UTC" >> "$GITHUB_ENV"
          echo "LC_ALL=C.UTF-8" >> "$GITHUB_ENV"
          echo "SOURCE_DATE_EPOCH=315532800" >> "$GITHUB_ENV"
          echo "PIP_DISABLE_PIP_VERSION_CHECK=1" >> "$GITHUB_ENV"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install lint/type deps
        run: |
          python -m pip install -U pip
          # Install dev extras (ruff, mypy, stubs, etc.)
          pip install -e .[dev]
          # Fallback in case mypy/ruff aren't in extras on forks
          pip install --upgrade --only-binary=:all: mypy ruff || pip install mypy ruff

      - name: Ruff (lint)
        run: |
          ruff --version
          ruff check .

      - name: Mypy (types)
        env:
          # Make types deterministic and quiet in CI
          MYPY_CACHE_DIR: .mypy_cache
        run: |
          mypy --version
          mypy

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          check-latest: true
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml

      - name: Deterministic env
        run: |
          echo "PYTHONUTF8=1" >> "$GITHUB_ENV"
          echo "PYTHONIOENCODING=UTF-8" >> "$GITHUB_ENV"
          echo "PYTHONHASHSEED=0" >> "$GITHUB_ENV"
          echo "TZ=UTC" >> "$GITHUB_ENV"
          echo "LC_ALL=C.UTF-8" >> "$GITHUB_ENV"
          echo "SOURCE_DATE_EPOCH=315532800" >> "$GITHUB_ENV"
          echo "PIP_DISABLE_PIP_VERSION_CHECK=1" >> "$GITHUB_ENV"
          echo "CLEMATIS_NETWORK_BAN=1" >> "$GITHUB_ENV"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install deps (dev+test extras) + YAML
        run: |
          python -m pip install -U pip
          pip install -e .[dev,test]
          # Ensure PyYAML is present (not included in extras)
          pip install pyyaml

      - name: Sanity imports
        continue-on-error: true
        run: |
          set -euxo pipefail
          python - <<'PY'
          import sys, os, traceback, importlib.util, site, pkgutil
          print("python:", sys.version)
          print("sys.executable:", sys.executable)
          print("sys.path[0:5]:", sys.path[:5])

          def show(msg, fn):
              print(f"\n--- {msg} ---")
              try:
                  fn()
                  print(f"--- {msg}: OK ---")
              except Exception as e:
                  print(f"*** {msg}: FAILED: {e}")
                  traceback.print_exc()

          def show_spec(name):
              spec = importlib.util.find_spec(name)
              print(f"find_spec({name!r}) ->", spec)

          show("pip list head", lambda: os.system("python -m pip list | head -n 50"))
          show("where site-packages", lambda: print(site.getsitepackages(), site.getusersitepackages()))

          show_spec("yaml")
          show("import yaml", lambda: __import__("yaml"))
          try:
              import yaml
              print("yaml version:", getattr(yaml, "__version__", "unknown"))
          except Exception:
              pass

          show_spec("clematis")
          show("import clematis", lambda: __import__("clematis"))
          try:
              import clematis
              print("clematis.__file__:", getattr(clematis, "__file__", None))
              root = os.path.dirname(getattr(clematis, "__file__", "") or "")
              print("ls clematis root:", os.listdir(root) if root and os.path.isdir(root) else "N/A")
          except Exception:
              pass

          show_spec("clematis.engine.stages.t4")
          def import_t4():
              import clematis.engine.stages.t4 as t4
              print("t4.__file__:", getattr(t4, "__file__", None))
              print("has t4_filter?", hasattr(t4, "t4_filter"))
          show("import clematis.engine.stages.t4", import_t4)
          PY

      - name: Run tests (offline)
        env:
          CLEMATIS_NETWORK_BAN: "1"
          CI: "true"
          PYTHONHASHSEED: "0"
        run: |
          set -euo pipefail
          pytest -q -m "not manual"

      - name: Examples smoke (GEL)
        env:
          CLEMATIS_NETWORK_BAN: "1"
          CI: "true"
        run: |
          set -euo pipefail
          python scripts/examples_smoke.py --examples examples/gel/disabled.yaml
          python scripts/examples_smoke.py --examples examples/gel/enabled.yaml

  reproducible_build:
    name: Reproducible build (wheel + sdist)
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          check-latest: true
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install build tooling
        run: |
          python -m pip install -U pip
          pip install build wheel

      - name: Compute SOURCE_DATE_EPOCH from Git
        id: sde
        run: echo "ts=$(git log -1 --pretty=%ct)" >> "$GITHUB_OUTPUT"

      - name: Export SDE for this job
        run: echo "SOURCE_DATE_EPOCH=${{ steps.sde.outputs.ts }}" >> "$GITHUB_ENV"

      - name: Export deterministic env
        run: |
          echo "PYTHONHASHSEED=0" >> "$GITHUB_ENV"
          echo "TZ=UTC" >> "$GITHUB_ENV"
          echo "LC_ALL=C.UTF-8" >> "$GITHUB_ENV"
          echo "LANG=C.UTF-8" >> "$GITHUB_ENV"
          echo "PYTHONUTF8=1" >> "$GITHUB_ENV"
          echo "PYTHONIOENCODING=UTF-8" >> "$GITHUB_ENV"

      - name: Clean tree (before build #1)
        run: |
          git clean -xfd

      - name: Build #1 and record hashes
        run: |
          set -euo pipefail
          rm -rf dist build
          python -m build
          # Record SHA256 hashes to RUNNER_TEMP (kept out of sdist)
          python - <<'PY'
          import hashlib, json, os, glob, tarfile

          def sha256_file(path):
              h = hashlib.sha256()
              with open(path, "rb") as f:
                  for chunk in iter(lambda: f.read(1<<20), b""):
                      h.update(chunk)
              return h.hexdigest()

          def sdist_content_hash(path):
              # Hash only the content of regular files inside the tar.gz, ignoring tar/gzip metadata.
              items = []
              with tarfile.open(path, "r:gz") as tf:
                  for m in tf.getmembers():
                      # Skip egg-info metadata folders; only hash payload semantics
                      if "/.egg-info/" in m.name or m.name.endswith(".egg-info"):
                          continue
                      # Also skip top-level PKG-INFO (sdist metadata)
                      if m.name == "PKG-INFO" or m.name.endswith("/PKG-INFO"):
                          continue
                      if not m.isfile():
                          continue
                      f = tf.extractfile(m)
                      data = f.read() if f else b""
                      h = hashlib.sha256(data).hexdigest()
                      items.append((m.name, h))
              items.sort()
              agg = hashlib.sha256()
              for name, h in items:
                  agg.update(name.encode("utf-8") + b"\0" + h.encode("ascii") + b"\n")
              return agg.hexdigest()

          out = {}
          for p in sorted(glob.glob("dist/clematis-*")):
              base = os.path.basename(p)
              if base.endswith(".tar.gz"):
                  out[base] = sdist_content_hash(p)
              else:
                  out[base] = sha256_file(p)

          out_path = os.path.join(os.environ.get("RUNNER_TEMP","."), "repro_sha_1.json")
          with open(out_path, "w") as f:
              json.dump(out, f, separators=(",", ":"))
          print("Wrote:", out_path, out)
          PY
          # Capture sdist file listing for debugging
          SDIST="$(ls dist/clematis-*.tar.gz)"
          tar -tzf "$SDIST" | sort > "$RUNNER_TEMP/sdist1.txt"

      - name: Verify examples included in artifacts
        run: |
          set -euo pipefail
          echo "Verify GEL examples are present in sdist and wheel"
          # sdist paths include a top-level project dir (e.g., name-version/)
          tar -tzf dist/*.tar.gz | grep -E '(^|/)examples/gel/(enabled|disabled)\.yaml$'
          # wheel paths use the data-files target path
          unzip -l dist/*.whl | grep -E 'share/examples/clematis/gel/(enabled|disabled)\.yaml'

      - name: Clean tree (before build #2)
        run: |
          git clean -xfd

      - name: Build #2 and record hashes (same SDE)
        run: |
          set -euo pipefail
          rm -rf dist build
          python -m build
          # Record SHA256 hashes to RUNNER_TEMP (kept out of sdist)
          python - <<'PY'
          import hashlib, json, os, glob, tarfile

          def sha256_file(path):
              h = hashlib.sha256()
              with open(path, "rb") as f:
                  for chunk in iter(lambda: f.read(1<<20), b""):
                      h.update(chunk)
              return h.hexdigest()

          def sdist_content_hash(path):
              items = []
              with tarfile.open(path, "r:gz") as tf:
                  for m in tf.getmembers():
                      # Skip egg-info metadata folders; only hash payload semantics
                      if "/.egg-info/" in m.name or m.name.endswith(".egg-info"):
                          continue
                      # Also skip top-level PKG-INFO (sdist metadata)
                      if m.name == "PKG-INFO" or m.name.endswith("/PKG-INFO"):
                          continue
                      if not m.isfile():
                          continue
                      f = tf.extractfile(m)
                      data = f.read() if f else b""
                      h = hashlib.sha256(data).hexdigest()
                      items.append((m.name, h))
              items.sort()
              agg = hashlib.sha256()
              for name, h in items:
                  agg.update(name.encode("utf-8") + b"\0" + h.encode("ascii") + b"\n")
              return agg.hexdigest()

          out = {}
          for p in sorted(glob.glob("dist/clematis-*")):
              base = os.path.basename(p)
              if base.endswith(".tar.gz"):
                  out[base] = sdist_content_hash(p)
              else:
                  out[base] = sha256_file(p)

          out_path = os.path.join(os.environ.get("RUNNER_TEMP","."), "repro_sha_2.json")
          with open(out_path, "w") as f:
              json.dump(out, f, separators=(",", ":"))
          print("Wrote:", out_path, out)
          PY
          # Capture sdist file listing for debugging
          SDIST="$(ls dist/clematis-*.tar.gz)"
          tar -tzf "$SDIST" | sort > "$RUNNER_TEMP/sdist2.txt"

      - name: Compare hashes (expect identical)
        run: |
          set -euo pipefail
          diff -u "$RUNNER_TEMP/repro_sha_1.json" "$RUNNER_TEMP/repro_sha_2.json"

      - name: Debug sdist content diff
        if: failure()
        run: |
          set -euo pipefail
          echo '--- sdist1 (first build) ---'
          cat "$RUNNER_TEMP/sdist1.txt" || true
          echo '--- sdist2 (second build) ---'
          cat "$RUNNER_TEMP/sdist2.txt" || true
          echo '--- unified diff ---'
          diff -u "$RUNNER_TEMP/sdist1.txt" "$RUNNER_TEMP/sdist2.txt" || true
