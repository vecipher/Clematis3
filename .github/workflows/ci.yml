name: ci
on:
  push: { branches: [main] }
  pull_request: { branches: [main] }

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint_types:
    name: Lint & Types
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install lint/type deps
        run: |
          python -m pip install -U pip
          # Install dev extras (ruff, mypy, stubs, etc.)
          pip install -e .[dev]
          # Fallback in case mypy/ruff aren't in extras on forks
          pip install --upgrade --only-binary=:all: mypy ruff || pip install mypy ruff

      - name: Ruff (lint)
        run: |
          ruff --version
          ruff check .

      - name: Mypy (types)
        env:
          # Make types deterministic and quiet in CI
          MYPY_CACHE_DIR: .mypy_cache
        run: |
          mypy --version
          mypy

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml

      - uses: dtolnay/rust-toolchain@stable

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install test tooling & build deps
        run: |
          python -m pip install -U pip build setuptools-rust wheel
          python -m pip install -U pytest pytest-timeout hypothesis pyyaml

      - name: Build wheel
        run: |
          set -euo pipefail
          rm -rf build dist *.egg-info
          python -m build -w

      - name: Install wheel (use installed pkg, not source tree)
        run: |
          set -euo pipefail
          python -m pip install --force-reinstall dist/*.whl
          python - <<'PY'
          import importlib, clematis
          print("clematis:", getattr(clematis, "__version__", "n/a"), "@", clematis.__file__)
          rs = importlib.import_module("clematis.native._t1_rs")
          print("_t1_rs:", rs.__file__, "caps/gel:", hasattr(rs, "propagate_one_graph_rs"), hasattr(rs, "gel_tick_decay"))
          PY

      - name: Sanity imports (wheel path)
        working-directory: /tmp
        run: |
          set -euxo pipefail
          python - <<'PY'
          import sys, importlib
          print("python:", sys.version)
          rs = importlib.import_module("clematis.native._t1_rs")
          print("_t1_rs ok:", hasattr(rs, "propagate_one_graph_rs"), hasattr(rs, "gel_tick_decay"))
          PY

      - name: Run tests (offline, wheel import)
        working-directory: /tmp
        env:
          CLEMATIS_NETWORK_BAN: "1"
          CI: "true"
          PYTHONHASHSEED: "0"
        run: |
          set -euo pipefail
          pytest -q -m "not manual" "$GITHUB_WORKSPACE/tests"

      - name: Caps parity (native path)
        working-directory: /tmp
        env:
          CLEMATIS_NATIVE_T1: "1"
          CI: "true"
        run: |
          set -euo pipefail
          pytest -q "$GITHUB_WORKSPACE/tests/native/test_parity_perf_on.py"
          pytest -q "$GITHUB_WORKSPACE/tests/native/test_caps_counters.py"

      - name: Strict parity over caps (advisory)
        continue-on-error: true
        working-directory: /tmp
        env:
          CLEMATIS_NATIVE_T1: "1"
          CLEMATIS_STRICT_PARITY: "1"
          CI: "true"
        run: |
          set -euo pipefail
          pytest -q "$GITHUB_WORKSPACE/tests/native/test_parity_perf_on.py"

      - name: Examples smoke (GEL)
        working-directory: /tmp
        env:
          CLEMATIS_NETWORK_BAN: "1"
          CI: "true"
        run: |
          set -euo pipefail
          python "$GITHUB_WORKSPACE/scripts/examples_smoke.py" --examples "$GITHUB_WORKSPACE/examples/gel/disabled.yaml"
          python "$GITHUB_WORKSPACE/scripts/examples_smoke.py" --examples "$GITHUB_WORKSPACE/examples/gel/enabled.yaml"

  reproducible_build:
    name: Reproducible build (wheel + sdist)
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install build tooling
        run: |
          python -m pip install -U pip
          pip install build wheel

      - name: Compute SOURCE_DATE_EPOCH from Git
        id: sde
        run: echo "ts=$(git log -1 --pretty=%ct)" >> "$GITHUB_OUTPUT"

      - name: Export SDE for this job
        run: echo "SOURCE_DATE_EPOCH=${{ steps.sde.outputs.ts }}" >> "$GITHUB_ENV"

      - name: Export deterministic env
        run: |
          echo "PYTHONHASHSEED=0" >> "$GITHUB_ENV"
          echo "TZ=UTC" >> "$GITHUB_ENV"
          echo "LC_ALL=C.UTF-8" >> "$GITHUB_ENV"
          echo "LANG=C.UTF-8" >> "$GITHUB_ENV"

      - name: Clean tree (before build #1)
        run: |
          git clean -xfd

      - name: Build #1 and record hashes
        run: |
          set -euo pipefail
          rm -rf dist build
          python -m build
          # Record SHA256 hashes to RUNNER_TEMP (kept out of sdist)
          python - <<'PY'
          import hashlib, json, os, glob, tarfile

          def sha256_file(path):
              h = hashlib.sha256()
              with open(path, "rb") as f:
                  for chunk in iter(lambda: f.read(1<<20), b""):
                      h.update(chunk)
              return h.hexdigest()

          def sdist_content_hash(path):
              # Hash only the content of regular files inside the tar.gz, ignoring tar/gzip metadata.
              items = []
              with tarfile.open(path, "r:gz") as tf:
                  for m in tf.getmembers():
                      # Skip egg-info metadata folders; only hash payload semantics
                      if "/.egg-info/" in m.name or m.name.endswith(".egg-info"):
                          continue
                      # Also skip top-level PKG-INFO (sdist metadata)
                      if m.name == "PKG-INFO" or m.name.endswith("/PKG-INFO"):
                          continue
                      if not m.isfile():
                          continue
                      f = tf.extractfile(m)
                      data = f.read() if f else b""
                      h = hashlib.sha256(data).hexdigest()
                      items.append((m.name, h))
              items.sort()
              agg = hashlib.sha256()
              for name, h in items:
                  agg.update(name.encode("utf-8") + b"\0" + h.encode("ascii") + b"\n")
              return agg.hexdigest()

          out = {}
          for p in sorted(glob.glob("dist/clematis-*")):
              base = os.path.basename(p)
              if base.endswith(".tar.gz"):
                  out[base] = sdist_content_hash(p)
              else:
                  out[base] = sha256_file(p)

          out_path = os.path.join(os.environ.get("RUNNER_TEMP","."), "repro_sha_1.json")
          with open(out_path, "w") as f:
              json.dump(out, f, separators=(",", ":"))
          print("Wrote:", out_path, out)
          PY
          # Capture sdist file listing for debugging
          SDIST="$(ls dist/clematis-*.tar.gz)"
          tar -tzf "$SDIST" | sort > "$RUNNER_TEMP/sdist1.txt"

      - name: Verify examples included in artifacts
        run: |
          set -euo pipefail
          echo "Verify GEL examples are present in sdist and wheel"
          # sdist paths include a top-level project dir (e.g., name-version/)
          tar -tzf dist/*.tar.gz | grep -E '(^|/)examples/gel/(enabled|disabled)\.yaml$'
          # wheel paths use the data-files target path
          unzip -l dist/*.whl | grep -E 'share/examples/clematis/gel/(enabled|disabled)\.yaml'

      - name: Clean tree (before build #2)
        run: |
          git clean -xfd

      - name: Build #2 and record hashes (same SDE)
        run: |
          set -euo pipefail
          rm -rf dist build
          python -m build
          # Record SHA256 hashes to RUNNER_TEMP (kept out of sdist)
          python - <<'PY'
          import hashlib, json, os, glob, tarfile

          def sha256_file(path):
              h = hashlib.sha256()
              with open(path, "rb") as f:
                  for chunk in iter(lambda: f.read(1<<20), b""):
                      h.update(chunk)
              return h.hexdigest()

          def sdist_content_hash(path):
              items = []
              with tarfile.open(path, "r:gz") as tf:
                  for m in tf.getmembers():
                      # Skip egg-info metadata folders; only hash payload semantics
                      if "/.egg-info/" in m.name or m.name.endswith(".egg-info"):
                          continue
                      # Also skip top-level PKG-INFO (sdist metadata)
                      if m.name == "PKG-INFO" or m.name.endswith("/PKG-INFO"):
                          continue
                      if not m.isfile():
                          continue
                      f = tf.extractfile(m)
                      data = f.read() if f else b""
                      h = hashlib.sha256(data).hexdigest()
                      items.append((m.name, h))
              items.sort()
              agg = hashlib.sha256()
              for name, h in items:
                  agg.update(name.encode("utf-8") + b"\0" + h.encode("ascii") + b"\n")
              return agg.hexdigest()

          out = {}
          for p in sorted(glob.glob("dist/clematis-*")):
              base = os.path.basename(p)
              if base.endswith(".tar.gz"):
                  out[base] = sdist_content_hash(p)
              else:
                  out[base] = sha256_file(p)

          out_path = os.path.join(os.environ.get("RUNNER_TEMP","."), "repro_sha_2.json")
          with open(out_path, "w") as f:
              json.dump(out, f, separators=(",", ":"))
          print("Wrote:", out_path, out)
          PY
          # Capture sdist file listing for debugging
          SDIST="$(ls dist/clematis-*.tar.gz)"
          tar -tzf "$SDIST" | sort > "$RUNNER_TEMP/sdist2.txt"

      - name: Compare hashes (expect identical)
        run: |
          set -euo pipefail
          diff -u "$RUNNER_TEMP/repro_sha_1.json" "$RUNNER_TEMP/repro_sha_2.json"

      - name: Debug sdist content diff
        if: failure()
        run: |
          set -euo pipefail
          echo '--- sdist1 (first build) ---'
          cat "$RUNNER_TEMP/sdist1.txt" || true
          echo '--- sdist2 (second build) ---'
          cat "$RUNNER_TEMP/sdist2.txt" || true
          echo '--- unified diff ---'
          diff -u "$RUNNER_TEMP/sdist1.txt" "$RUNNER_TEMP/sdist2.txt" || true
