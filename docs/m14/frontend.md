

# M14 — Frontend Viewer (offline) & Console (docs-only)

**Status:** Docs-only drop on **2025-10-09 SGT**. No behavior changes to v3.
**Scope:** How to build and use the offline viewer, how to export/load run bundles, determinism guarantees, and troubleshooting.

---

## 1) What the viewer is (and isn’t)

- **Static, offline** HTML+ESM UI for inspecting runs: open via `file://…/frontend/dist/index.html`.
- No network calls. Tests enforce **zero `http(s)` requests** on load (see `tests/frontend/test_offline_browser.py`).
- Targets **operator diagnostics**: list runs, view snapshot summaries, inspect stage logs; **perf logs** are opt-in.
- Experimental visuals (graph/memory) exist but are **gated OFF** by default.

**UI markers (stable selectors):**
- Tabs container: `#tabs` with buttons `[data-tab]` (e.g., “runs”, “snapshots”, “logs”).
- File loader: `#fileInput` (accepts multiple `run_bundle.json`).
- Clear button: `#btnClear`.
- Runs list: `#runsList`.
- Snapshot panel: `#runSelect`, `#btnCopySnapshot`, `#snapshot`.
- Perf toggle: `#perf-toggle` (default **OFF**, attached but hidden).
- Logs panel: `#logSearch`, stage tabs `[data-stage]`, list container `#logList`, counts `#logCounts`.
- Experimental toggle: `#exp-toggle` (default **OFF**).

---

## 2) File layout & build sources

The viewer prefers **TypeScript-compiled** assets when present; otherwise it falls back to JS sources.

- HTML entry: `frontend/index.html` → built to `frontend/dist/index.html`.
- Preferred assets: `frontend/tsdist/assets/**` (generated by `tsc`).
- Fallback assets: `frontend/src/*.js`.
- Styles: `frontend/styles/**`.
- Build helper: `scripts/build_frontend.py` (copies with LF normalization).

**Builder rule:** _Prefer_ `tsdist/assets/**` if present, _else_ `src/*.js`. Compiled JS is committed to keep CI deterministic.

---

## 3) Building the viewer (deterministic, offline)

We commit compiled assets; rebuild locally when you change TS/JS.

**Prereqs (dev-only build):**
- Node **20.19.5** (engine guard is `&gt;=20.11 &lt;21`)
- npm **10.x**
- TypeScript pinned: **5.6.3**

**Build steps:**
```bash
# at repo root
npm ci --prefix frontend
npm run --prefix frontend build
make frontend-build
```

This produces `frontend/dist/` with:
- `index.html` (LF newlines)
- `assets/` (compiled ESM from `frontend/tsdist/assets` or JS fallback from `frontend/src`)

Verify determinism & offline locally:

```bash
bash scripts/repro_check_local.sh --frontend
# Runs two builds, compares directory hash, greps for external URLs (no finds expected)
```

---

## 4) Opening the viewer & loading bundles

Open directly in a browser:

```
file://…/frontend/dist/index.html
```

Then **Load** one or more `run_bundle.json` files via the **Runs** tab file picker (`#fileInput`).

**Where do bundles come from?** From the console (next section).

---

## 5) Producing run bundles with the console

The console is a deterministic driver around the orchestrator.

**Examples:**
```bash
# Print scheduler/budgets JSON
python -m clematis console -- status

# Deterministic one turn (writes run_bundle.json)
TZ=UTC PYTHONHASHSEED=0 SOURCE_DATE_EPOCH=315532800 CLEMATIS_NETWORK_BAN=1 \
python -m clematis console -- step --now-ms 315532800000 --out /tmp/run.json

# Compare two bundles (exit non-zero on diffs)
python -m clematis console -- compare --a /tmp/run.json --b /tmp/run.json
```

**Tests covering console identity:** `tests/frontend/test_console_identity.py`.

---

## 6) Determinism & offline guarantees

- **No network:** Viewer makes no `http(s)` requests on load. Enforced by Playwright across **Ubuntu/macOS/Windows**:
  - `tests/frontend/test_offline_browser.py` opens `file://…/frontend/dist/index.html`, captures all requests, fails on any `http(s)://`.
- **Deterministic build:**
  - LF line endings and path normalization; stable directory hash (via repo scripts).
  - Pinned TS compiler (**5.6.3**). No bundlers; `tsc` only.
  - `make frontend-build` canonicalizes outputs.
- **Recommended env for identity/repro:**
  ```
  TZ=UTC
  PYTHONUTF8=1
  PYTHONHASHSEED=0
  LC_ALL=C.UTF-8
  SOURCE_DATE_EPOCH=315532800
  CLEMATIS_NETWORK_BAN=1
  ```

---

## 7) Experimental toggles (default OFF)

- **Perf logs** (`#perf-toggle`): shows non-canonical diagnostics; identity/goldens ignore these files.
- **Experimental visuals** (`#exp-toggle`): reveals “Graph (exp)” and “Memory (exp)” tabs backed by `frontend/src/exp/*`.
- Both are **opt-in** and not required for CI.

---

## 8) Troubleshooting

- **`frontend/dist/index.html` missing**
  - Run:
    ```bash
    npm ci --prefix frontend && npm run --prefix frontend build && make frontend-build
    ```
- **Playwright test skipped**
  - It skips if `frontend/dist/index.html` is absent. Build first.
- **Viewer shows but assets missing**
  - Ensure `frontend/tsdist/assets/app.js` exists (TS build) or `frontend/src/app.js` (JS fallback).
- **Windows loopback / asyncio bootstrap**
  - Our network-ban fixture allows loopback (`127.0.0.1`, `::1`, `localhost`) so Playwright/asyncio can start, while still banning external sockets.
- **Repro check fails**
  - Match Node/npm versions to `frontend/package.json` engines; ensure no local edits created extra diffs. Re-run `scripts/repro_check_local.sh --frontend`.
- **Grep false positives**
  - If your local grep flags the SVG namespace (`www.w3.org/2000/svg`), ignore it—Playwright already enforces zero network.

---

## 9) Pointers

- Viewer sources: `frontend/index.html`, `frontend/src`, `frontend/tsdist/assets`, `frontend/styles/*`.
- Build helper: `scripts/build_frontend.py`.
- Repro: `scripts/repro_check_local.sh --frontend`.
- Tests: `tests/frontend/test_viewer_smoke.py`, `tests/frontend/test_offline_browser.py`, `tests/frontend/test_console_identity.py`.
- Related PRs: PR130 (TS viewer), PR131 (console), PR132 (offline & reproducibility).
